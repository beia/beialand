version: '3.6'

services:
  graphite:
    image: vladwing/graphite
    volumes:
      - graphite:/opt/graphite/storage
      - graphite_conf:/opt/graphite/conf
    environment:
      VIRTUAL_HOST: 'graphite.beia.cloud,graphite.beia-telemetrie.ro,graphite.beia-consult.ro'
      VIRTUAL_PORT: 80
    networks:
     - graphite
     - proxy_net

  influxdb:
    image: influxdb
    environment:
      - INFLUXDB_GRAPHITE_ENABLED=true
    volumes:
      - influxdb:/var/lib/influxdb
    networks:
      - influxdb

  chronograf:
    image: chronograf:1.3.8
    deploy:
      replicas: 0
    environment:
      INFLUXDB_URL: http://influxdb:8086
      KAPACITOR_URL: http://kapacitor:9092
      VIRTUAL_HOST: 'chronograf.beia.cloud'
      VIRTUAL_PORT: 8888
    networks:
      - influxdb
      - proxy_net

  kapacitor:
    image: kapacitor:1.3.3
    environment:
      KAPACITOR_HOSTNAME: kapacitor
      KAPACITOR_INFLUXDB_0_URLS_0: http://influxdb:8086
    networks:
      - influxdb

  grafana:
    image: grafana/grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD__FILE: '/run/secrets/grafana_password'
      VIRTUAL_HOST: 'grafana.beia.cloud,grafana.beia-telemetrie.ro,grafana.beia-consult.ro'
    networks:
     - graphite
     - proxy_net
    volumes:
      - grafana:/var/lib/grafana
    secrets:
      - grafana_password

  statsd:
    image: vladwing/statsd
    environment:
      GRAPHITE_HOST: 'graphite'
    networks:
     - graphite
     - statsd_net

  iot-data:
    image: postgres
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    volumes:
      - iot-data:/var/lib/postgresql/data
    networks:
      - graphite
    secrets:
      - postgres_password

  broker:
    image: beia/mqtt-broker
    volumes:
     - mosca:/db
    ports:
     - "1883:1883"
    environment:
      VIRTUAL_HOST: 'mqtt.beia-consult.ro'
      VIRTUAL_PORT: 80
      REDIS_HOST: 'redis'
    networks:
     - redis
     - broker
     - proxy_net

  redis:
    image: redis:alpine
    networks:
     - redis
    volumes:
     - redis:/data

  # MQTT -- Graphite Midleware
  mqtt2graphite:
    image: beia/mqtt-to-graphite
    environment:
      - CARBON_SERVER=graphite
      # - CARBON_PORT=2003
      - MQTT_HOST=broker
      # -MQTT_PORT=1883
    networks:
     - broker
     - graphite

  mqtt2influxdb:
    image: beia/mqtt-to-graphite
    environment:
      - CARBON_SERVER=influxdb
      # - CARBON_PORT=2003
      - MQTT_HOST=broker
      # -MQTT_PORT=1883
    networks:
     - broker
     - influxdb



  mqtt2postgres:
    image: vladwing/hang
    networks:
      - broker
      - graphite

volumes:
  graphite:
  graphite_conf:
  grafana:
  mosca:
  redis:
  iot-data:
  influxdb:
networks:
  redis:
  graphite:
  broker:
  influxdb:
  statsd_net:
    external: true
  proxy_net:
    external: true
secrets:
  postgres_password:
    external: true
  grafana_password:
    external: true
