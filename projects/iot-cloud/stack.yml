version: '3.6'

services:
  graphite:
    image: vladwing/graphite
    volumes:
      - graphite:/opt/graphite/storage
    networks:
     - graphite

  grafana:
    image: grafana/grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: '${GRAFANA_PASSWORD:-secret}'
      VIRTUAL_HOST: 'grafana.beia.cloud,grafana.beia-telemetrie.ro,grafana.beia-consult.ro'
    networks:
     - graphite
     - proxy_net
    volumes:
      - grafana:/var/lib/grafana

  broker:
    image: beia/mqtt-broker
    volumes:
     - mosca:/db
    ports:
     - "1883:1883"
    environment:
      VIRTUAL_HOST: 'mqtt.beia-consult.ro'
      VIRTUAL_PORT: 80
      REDIS_HOST: 'redis'
    networks:
     - redis
     - broker
     - proxy_net

  redis:
    image: redis:alpine
    networks:
     - redis
    volumes:
     - redis:/data

  # MQTT -- Graphite Midleware
  mqtt2graphite:
    image: beia/mqtt-to-graphite
    environment:
      - CARBON_SERVER=graphite
      # - CARBON_PORT=2003
      - MQTT_HOST=broker
      # -MQTT_PORT=1883
    networks:
     - broker
     - graphite

volumes:
  graphite:
  grafana:
  mosca:
  redis:
networks:
  redis:
  graphite:
  broker:
  proxy_net:
    external: true
